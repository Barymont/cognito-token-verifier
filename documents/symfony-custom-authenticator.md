### This is an example of implementation in Symfony. Here are the steps:

1. Install the dependency to your project check the [README](../README.md) file, in the section [Installation](../README.md#installation)

2. Install the Security bundle in your Symfony project.

```BASH
   composer require symfony/security-bundle
```

3. Add new enviroment variables.

```CONF
    AWS_COGNITO_USER_POOL_ID=us-east-1_XXXXXXXXX
    AWS_COGNITO_APP_CLIENTS_ALLOWED_IDS=XXXXXXXXXXXXXXXXXXXXXXXXXX,XXXXXXXXXXXXXXXXXXXXXXXXXX
```

**AWS_COGNITO_USER_POOL_ID** Is the ID of the user pool in Cognito, you can find it in the Cognito console, in the section "General settings" of your user pool.
**AWS_COGNITO_APP_CLIENTS_ALLOWED_IDS** Is a comma separated list of the Client IDs of the applications that are allowed to use the tokens, you can find it in the Cognito console, in the section "App clients" of your user pool. This is a security measure to avoid that a token generated by one application is used in another application. If you don't want to use this security measure, you can set this variable to an empty string.

4. Configure a custom Authenticator class, for example:

```PHP

   use CognitoTokenVerifier\Application\Verifier;
   use CognitoTokenVerifier\Domain\DummySymfonyUser;

   /**
    * Example of an Authenticator class that uses the Verifier class to verify the token
    * and the DummySymfonyUser class to create a dummy user to be used in the Symfony security system
    * This class is an example of implementation, you can use your own classes to verify the token and create the user
    */
   final class CognitoAuthenticator extends AbstractAuthenticator implements AuthenticationEntryPointInterface
   {
       public function __construct(private Verifier $verifier)
       {
       }

       public function start(Request $request, AuthenticationException $authException = null): JsonResponse
       {
           return new JsonResponse(['message' => 'Authentication Required'], 401);
       }

       public function supports(Request $request): ?bool
       {
           if (false === $request->headers->has('Authorization')) {
               throw new AuthenticationException('Access Token is required', 401);
           }

           return true;
       }

       public function authenticate(Request $request): Passport
       {

           $token = $this->getBearerHeader($request);

           try {

               $this->verifier->__invoke($token, $request->attributes->get('required_scopes'));

           }catch(\Exception $e) {
               throw new AuthenticationException($e->getMessage(), 401);
           }

           return new SelfValidatingPassport(new UserBadge($token, function ($token) {
               return new DummySymfonyUser($token);
           }));
       }

       public function onAuthenticationSuccess(Request $request, TokenInterface $token, string $firewallName): ?Response
       {
           return null;
       }

       public function onAuthenticationFailure(Request $request, AuthenticationException $exception): ?JsonResponse
       {
           return new JsonResponse(['message' => "Authentication failed"], 401);
       }

       private function getBearerHeader(Request $request): ?string
       {
           $header = $request->headers->get('Authorization');
           if (empty($header)) {
               return null;
           }

           if (0 !== strpos($header, 'Bearer ')) {
               return null;
           }

           return trim(ltrim($header, 'Bearer'));
       }
   }
```

5. Configure the service in the service config file, for example:

```XML
    <service id="CognitoTokenVerifier\Infrastructure\FromFileKeysRepository" autowire="true">
       <argument key="$keysFilePath">%kernel.project_dir%/config/keys.json</argument>
    </service>

    <service id="CognitoTokenVerifier\Application\Verifier" autowire="true">
       <argument key="$cognitoUserPoolId">%env(AWS_COGNITO_USER_POOL_ID)%</argument>
       <argument key="$keysRepository" type="service" id="CognitoTokenVerifier\Infrastructure\FromFileKeysRepository"/>
       <argument key="$cognitoAppClientsAllowedIds">%env(AWS_COGNITO_APP_CLIENTS_ALLOWED_IDS)%</argument>
    </service>

```

```YML
    CognitoTokenVerfier\Infrastructure\FromFileKeysRepository:
        arguments:
            $keysFilePath: '%kernel.project_dir%/config/keys.json'
        autowire: true

    CognitoTokenVerifier\Application\Verifier:
        arguments:
            $cognitoUserPoolId: '%env(AWS_COGNITO_USER_POOL_ID)%'
            $keysRepository: '@CognitoTokenVerifier\Infrastructure\FromFileKeysRepository'
            $cognitoAppClientsAllowedIds: '%env(AWS_COGNITO_APP_CLIENTS_ALLOWED_IDS)%'
        autowire: true

```

```PHP
    $container->autowire(FromFileKeysRepository::class)
        ->setArguments([
            '$keysFilePath' => '%kernel.project_dir%/config/keys.json'
        ]);

    $container->autowire(Verifier::class)
        ->setArguments([
            '$cognitoUserPoolId' => '%env(AWS_COGNITO_USER_POOL_ID)%',
            '$keysRepository' => '@CognitoTokenVerifier\Infrastructure\FromFileKeysRepository',
            '$cognitoAppClientsAllowedIds' => '%env(AWS_COGNITO_APP_CLIENTS_ALLOWED_IDS)%'
        ]);

```

6. Adds required scopes to the routes that need authentication, for example: (This is optional, if you don't add the required scopes, the token will be verified but the scopes will not be checked)

```XML
<routes xmlns="http://symfony.com/schema/routing"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://symfony.com/schema/routing
        http://symfony.com/schema/routing/routing-1.0.xsd">

    <route id="secured-route" path="/secured" methods="POST" controller="MyBussines\Apps\HttpApi\Controller\SecuredAreaController">
        <default key="required_scopes">
            <list>
                <string>https://service.api.com/read</string>
                <string>https://service.api.com/delete</string>
            </list>
        </default>
    </route>

</routes>
```

```YML
secured-route:
    path: /secured
    controller: MyBussines\Apps\HttpApi\Controller\SecuredAreaController
    methods: POST
    defaults:
        required_scopes:
            - https://service.api.com/read
            - https://service.api.com/delete
```

```PHP
    use Symfony\Component\Routing\Annotation\Route;

    #[Route('/secured', name: 'secured-route', methods: ['POST'], defaults: ['required_scopes' => ['https://service.api.com/read', 'https://service.api.com/delete']])]
    final class SecuredAreaController
    {
        public function __invoke(): JsonResponse
        {
            return new JsonResponse(['message' => 'This is a secured area']);
        }
    }
```
